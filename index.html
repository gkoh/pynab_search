<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <title>pynab API search</title>

        <!-- Bootstrap -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.4/flatly/bootstrap.min.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
            <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
            <![endif]-->

        <style>
            th {
                background-color: LightGray;
                text-align: center;
            }
        </style>
    </head>

    <body onload="body_load()">

        <!-- Static navbar -->
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <span class="navbar-brand">pynab</span>
                </div>

                <div id="navbar" class="navbar-collapse collapse">
                    <ul class="nav navbar-nav navbar-left">
                        <li class="active"><a href="#search">Search</a></li>
                        <li><a href="#stats">Stats</a></li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="#settings"><span class="glyphicon glyphicon-cog" aria-hidden="true"></span></a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="row">
            <div class="col-lg-1"></div>
            <div id='alert-wrapper' class="col-lg-10"></div>
            <div class="col-lg-1"></div>
        </div>

        <div class="container-fluid">
            <div class="content" id="search">
                <h1>Search</h1>
                <div class="row">
                    <div class="col-lg-12">
                        <div class="input-group">
                            <input id="search_string" type="text" class="form-control" style="width: 80%" placeholder="Search for...">
                            <select id="search_cat" class="form-control" style="width: 20%" disabled><option value="-1">Loading...</option></select>
                            <span class="input-group-btn">
                                <button id='search_all_default' class="btn btn-default" type="button">
                                    <span class="glyphicon glyphicon-search"></span>
                                </button>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="col-lg-12">
                    <hr></hr>
                    <div id="results_table"></div>
                </div>
            </div>

            <div class="content" id="stats" hidden="true">
                <h1>Stats</h1>
                <div class="col-lg-12">
                    <hr></hr>
                    <div id="stats_completion"></div>
                    <ul class="list-group">
                        <li class="list-group-item">
                            <span class="badge" id="total_tv">0</span>
                            <label for="progress_tv">TV</label>
                            <div id="progress_tv" class="progress">
                                <div class="progress-bar progress-bar-success" id="progress_tv_success" role="progressbar" style="width:0%">
                                    Processed
                                </div>
                                <div class="progress-bar progress-bar-danger" id="progress_tv_failed" role="progressbar" style="width:0%">
                                    Failed
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <span class="badge" id="total_movies">0</span>
                            <label for="progress_movies">Movies</label>
                            <div id="progress_movies" class="progress">
                                <div class="progress-bar progress-bar-success" id="progress_movies_success" role="progressbar" style="width:0%">
                                    Processed
                                </div>
                                <div class="progress-bar progress-bar-danger" id="progress_movies_failed" role="progressbar" style="width:0%">
                                    Failed
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <span class="badge" id="total_nfos">0</span>
                            <label for="progress_nfos">NFOs</label>
                            <div id="progress_nfos" class="progress">
                                <div class="progress-bar progress-bar-success" id="progress_nfos_success" role="progressbar" style="width:0%">
                                    Processed
                                </div>
                                <div class="progress-bar progress-bar-danger" id="progress_nfos_failed" role="progressbar" style="width:0%">
                                    Failed
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <span class="badge" id="total_file_info">0</span>
                            <label for="progress_file_info">File Info</label>
                            <div id="progress_file_info" class="progress">
                                <div class="progress-bar progress-bar-success" id="progress_file_info_success" role="progressbar" style="width:0%">
                                    Processed
                                </div>
                                <div class="progress-bar progress-bar-danger" id="progress_file_info_failed" role="progressbar" style="width:0%">
                                    Failed
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="content" id="settings" hidden="true">
                <h1>Settings</h1>
                <hr>
                <h2>pynab</h2>
                <hr>
                <div class="form-group">
                    <div class="row">
                        <div class="col-lg-3">
                            <label for='apikey'>API Key</label>
                        </div>
                        <div class="col-lg-9">
                            <input id="apikey" type="text" class="form-control" placeholder="API key...">
                        </div>
                    </div>
                </div>
                    <div class="row">
                        <div class="col-lg-1">
                            <h2>sabnzbd</h2>
                        </div>
                        <div class="col-lg-11 text-left" style="padding-top: 30px;">
                            <span id="sabstatus" class="glyphicon glyphicon-remove text-danger"></span>
                        </div>
                    </div>
                <hr>
                <div class="form-group">
                    <div class="row">
                        <div class="col-lg-3">
                            <label for='saburl'>API URL</label>
                        </div>
                        <div class="col-lg-9">
                            <input id="saburl" type="text" class="form-control" placeholder="https://sabhost:9090/api">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-3">
                            <label for='sabapikey'>API Key</label>
                        </div>
                        <div class="col-lg-9">
                            <input id="sabapikey" type="text" class="form-control" placeholder="SAB API Key...">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-3">
                            <label for='sabuser'>Username</label>
                        </div>
                        <div class="col-lg-9">
                            <input id="sabuser" type="text" class="form-control" placeholder="Username (optional)">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-3">
                            <label for='sabpass'>Password</label>
                        </div>
                        <div class="col-lg-9">
                            <input id="sabpass" type="password" class="form-control" placeholder="Password (optional)">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <!-- Include all compiled plugins (below), or include individual files as needed -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/js/bootstrap.min.js"></script>
        <!-- jQuery timeago -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-timeago/1.4.1/jquery.timeago.min.js"></script>
        <!-- filesize.js -->
        <script src="js/filesize.min.js"></script>
        <!-- jQuery cookie -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>

        <style>
          .glyphicon-spin {
            -webkit-animation: spin 1000ms infinite linear;
            animation: spin 1000ms infinite linear;
          }
          @-webkit-keyframes spin {
            0% {
              -webkit-transform: rotate(0deg);
              transform: rotate(0deg);
            }
            100% {
              -webkit-transform: rotate(359deg);
              transform: rotate(359deg);
            }
          }
          @keyframes spin {
            0% {
              -webkit-transform: rotate(0deg);
              transform: rotate(0deg);
            }
            100% {
              -webkit-transform: rotate(359deg);
              transform: rotate(359deg);
            }
          }
        </style>

        <script type="text/javascript">
            var baseurl = '../api?';

            function body_load () {
                // Get all the settings fields.
                $('#settings input').each(function (index) {
                    // Populate the field from the cookie.
                    var value = $.cookie($(this).attr('id'));
                    if (value) {
                        $(this).val(value);
                    }

                    // Set a handler so the cookie is updated when the field is.
                    $(this).change(function () {
                        save_setting($(this).attr('id'), $(this).val());
                    })

                    $(this).keydown(function(e) {
                        // Enter Key to save.
                        if (e.which == 13) {
                            save_setting($(this).attr('id'), $(this).val());
                        }
                        // Escape Key to undo.
                        if (e.which == 27) {
                            $(this).val($.cookie($(this).attr('id')));
                        }
                    });
                });

                populate_search_cats();
                sab_test();
                $('#search_string').focus();
            }

            function save_setting (attr, value) {
              $.cookie(attr, value, { expires: 180 });
              if (attr.match(/^sab/)) {
                sab_test();
              }
            }

            function do_search (search_type, search_string, search_cat) {
                $('#results_table').html('<div class="text-center"><span class="glyphicon glyphicon-refresh glyphicon-spin"></span></div>');

                var params = {
                    t      : search_type,
                    o      : 'json',
                    limit  : 100,
                    apikey : $.cookie('apikey'),
                    q      : search_string,
                };

                if (search_cat > 0) {
                    params['cat'] = search_cat;
                }

                if (!params.apikey) {
                    pynab_alert("No API Key Specified");
                    return;
                }

                var pynab_url = baseurl + $.param(params);

                $.getJSON(pynab_url, function (data) {
                    // Check for an error from pynab.
                    if (data.error) {
                        $('#results_table').html('');
                        pynab_alert("<strong>Error Loading Results</strong>: " + data.error.description);
                        return;
                    }


                    $('#results_table').html('');
                    $('#results_table').children('table').remove();
                    $('#results_table').append('<table class="table table-striped table-bordered text-center">');
                    var results_table = $('#results_table').children();

                    var header = $('<thead>').appendTo(results_table);
                    var header_row = $('<tr>').appendTo(header);
                    header_row.append($('<th>').text('Age'),
                            $('<th>').text('Title'),
                            $('<th>').text('Category'),
                            $('<th>').text('Size'),
                            $('<th>').text('Download'));

                    $.each(data.rss.channel.item, function (index, element) {
                        var links = '<a href="' + element.link + '"><span class="glyphicon glyphicon-download"></span></a>';
                        if ($.cookie('saburl')) {
                            links += '&nbsp;&nbsp;<a id="sab' + index + '" href="#"><img src="//sabnzbd.org/icon/sab2_16.png"></img></a>';
                        }

                        $('<tr>').append(
                                $('<td>').text(jQuery.timeago(Date.parse(element.pubDate))),
                                $('<td>').text(element.title),
                                $('<td>').text(element.category),
                                $('<td>').text(filesize(element.size)),
                                $('<td>').html(links)
                                ).appendTo(results_table);

                        if ($.cookie('saburl')) {
                            sab_init_link(index, element.link, element.title);
                        }
                    });
                }).fail(function (data, status, msg) {
                    $('#results_table').html('');
                    pynab_alert("<strong>Error Loading Results</strong>: " + msg);
                });
            }

            function sab_init_link(index, url, name) {
                $('#sab' + index).click(function(){
                    sab_add(index, url, name);
                })
            }

            function pynab_alert (message) {
                $('#alert-wrapper').append(
                    '<div class="alert alert-danger" data-dismiss="alert">'+
                        '<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>'+
                        message+
                    '</div>');
            }

            function sab_add (index, url, name) {
                var orig = $('#sab' + index).clone();

                $('#sab' + index).replaceWith('<span id="sabspinner' + index + '" class="glyphicon glyphicon-refresh glyphicon-spin"></span>');

                $.ajax({
                    'url'    : $.cookie('saburl'),
                    'method' : 'GET',
                    'data'   : {
                        'mode'    : 'addurl',
                        'apikey'  : $.cookie('sabapikey'),
                        'name'    : url,
                        'nzbname' : name,
                        'output'  : 'json'
                    },
                    'username' : $.cookie('sabuser'),
                    'password' : $.cookie('sabpass'),
                    'dataType' : 'jsonp', // Use jsonp to get around cors issues.
                    'timeout'  : 5000,  // Give the jsonp 5 seconds to return (only way to do jsonp error handling)
                }).done(function (r) {
                    if (r.status) {
                        // If the queue add worked, replace the link with a green sab logo.
                        $('#sabspinner' + index).replaceWith('<img src="//sabnzbd.org/icon/nzb/nzb_16.png"></img>');
                    }
                    else {
                        $('#sabspinner' + index).replaceWith(orig);
                        sab_init_link(index, url, name);
                        pynab_alert('<strong>Sabnzbd Error : </strong>'+r.error+"<br>"+
                                    '<strong>Error queuing : </strong>'+name);
                    }
                }).fail(function (data, status, msg) {
                    $('#sabspinner' + index).replaceWith(orig);
                    sab_init_link(index, url, name);
                    pynab_alert('<strong>Unknown Error : </strong> Check sabnzbd configuration<br>'+
                                '<strong>Error queuing : </strong>'+name);
                });
            }

            function sab_test () {
                if (!$.cookie('saburl') || !$.cookie('sabapikey')) {
                    $('#sabstatus').replaceWith('<span id="sabstatus" class="glyphicon glyphicon-remove text-danger"></span>');
                    return;
                }

                $('#sabstatus').replaceWith('<span id="sabstatusspinner" class="glyphicon glyphicon-refresh glyphicon-spin"></span>');

                $.ajax({
                    'url'    : $.cookie('saburl'),
                    'method' : 'GET',
                    'data'   : {
                        'mode'    : 'get_config',
                        'section' : 'servers',
                        'apikey'  : $.cookie('sabapikey'),
                        'output'  : 'json'
                    },
                    'username' : $.cookie('sabuser'),
                    'password' : $.cookie('sabpass'),
                    'dataType' : 'jsonp', // Use jsonp to get around cors issues.
                    'timeout'  : 5000,  // Give the jsonp 5 seconds to return (only way to do jsonp error handling)
                }).done(function (r) {
                    if (r.config) {
                        $('#sabstatusspinner').replaceWith('<span id="sabstatus" class="glyphicon glyphicon-ok text-success"></span>');
                    }
                    else {
                        $('#sabstatusspinner').replaceWith('<span id="sabstatus" class="glyphicon glyphicon-remove text-danger"></span>');
                    }
                }).fail(function (data, status, msg) {
                    $('#sabstatusspinner').replaceWith('<span id="sabstatus" class="glyphicon glyphicon-remove text-danger"></span>');
                });
            }

            function populate_search_cats () {
                var params = {
                    'o' : 'json',
                    't' : 'caps'
                };

                var cats_url = baseurl + $.param(params);

                $.getJSON(cats_url, function (data) {
                    $('#search_cat').prop('disabled', false);
                    $('#search_cat').html('<option value="-1")>All</option>');

                    $.each(data.caps.categories.category, function (index, cat) {
                        $('#search_cat').append('<option value="' + cat.id + '">' + cat.name + '</option>');

                        $.each(cat.subcat, function (index, subcat) {
                            $('#search_cat').append('<option value="' + subcat.id + '">' + cat.name + ' > ' + subcat.name + '</option>');
                        });
                    });
                }).fail(function (data, status, msg) {
                    pynab_alert("<strong>Error Loading Categories</strong>: " + msg);
                });
            }

            $(document).ready(function() {
                var progress_map = {
                    "TV"        : "tv",
                    "Movies"    : "movies",
                    "NFOs"      : "nfos",
                    "File Info" : "file_info" };

                var params = {
                    t: 'stats',
                    o: 'json' };

                var pynab_url = baseurl + $.param(params);

                $.getJSON(pynab_url, function (data) {
                    $.each(data.stats.totals.total, function (index, element) {
                        var id_success = 'progress_' + progress_map[element.label] + '_success';
                        var id_failed = 'progress_' + progress_map[element.label] + '_failed';
                        var id_total = 'total_' + progress_map[element.label];
                        var pct_success = Math.round(100 * element.processed/element.total) + '%';
                        var pct_failed = Math.round(100 * element.failed/element.total) + '%';

                        $('#' + id_success).css('width', pct_success);
                        $('#' + id_failed).css('width', pct_failed);
                        document.getElementById(id_success).innerHTML = pct_success;
                        document.getElementById(id_failed).innerHTML = pct_failed;
                        document.getElementById(id_total).innerHTML = element.total;
                    });
                }).fail(function (data, status, msg) {
                    pynab_alert("<strong>Error Loading Stats</strong>: " + msg);
                });
            });

            /* Handle 'enter' in the search bar. */
            $('#search_string').keypress(function(e) {
                if (e.which == 13) {
                    do_search('search', $('#search_string').val(), $('#search_cat').val());
                }
            });

            /* Search button clicked. */
            $('#search_all_default').on('click', function(e) {
                do_search('search', $('#search_string').val(), $('#search_cat').val());
            });

            /* navbar handling. */
            $('.navbar-nav a').on('click', function(e) {
                e.preventDefault();
                /* Disable active on all menu items. */
                $(this).parent().parent().find('.active').removeClass('active');
                $('.nav').find('.active').removeClass('active');
                /* Enable active on the current menu. */
                $(this).parent().addClass('active');
                /* Hide the previous content. */
                $('.content').hide();
                /* Show the current active content. */
                $($(this).attr('href')).show();

                if ($(this).attr('href') == '#search') {
                    $('#search_string').focus();
                }
            });

        </script>

    </body>
</html>
